<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üé¥ Jogo da Mem√≥ria dos Veloso - Painel do Operador</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Pacifico&family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --roxo: #667eea;
      --roxo-escuro: #5a67d8;
      --rosa: #f093fb;
      --rosa-forte: #ec4899;
      --azul: #4facfe;
      --verde: #43e97b;
      --laranja: #f5af19;
      --amarelo: #ffd700;
      --vermelho: #ef4444;
      --bg-dark: #1a1a2e;
      --bg-card: #16213e;
      --text-light: #ffffff;
      --text-muted: rgba(255,255,255,0.7);
    }

    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, var(--bg-dark) 0%, #0f0f23 100%);
      min-height: 100vh;
      color: var(--text-light);
      overflow-x: hidden;
    }

    /* Background animado */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: 
        radial-gradient(circle at 20% 80%, rgba(102, 126, 234, 0.15) 0%, transparent 50%),
        radial-gradient(circle at 80% 20%, rgba(240, 147, 251, 0.15) 0%, transparent 50%),
        radial-gradient(circle at 50% 50%, rgba(79, 172, 254, 0.1) 0%, transparent 60%);
      pointer-events: none;
      z-index: -1;
    }

    /* Header */
    .header {
      background: linear-gradient(135deg, var(--roxo) 0%, var(--rosa) 100%);
      padding: 20px 40px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 4px 30px rgba(102, 126, 234, 0.4);
    }

    .logo {
      font-family: 'Pacifico', cursive;
      font-size: 2.5rem;
      color: white;
      text-shadow: 3px 3px 6px rgba(0,0,0,0.3);
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .logo-emoji {
      font-size: 3rem;
      animation: bounce 2s ease-in-out infinite;
    }

    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }

    .btn-reset {
      background: rgba(255,255,255,0.2);
      border: 2px solid white;
      color: white;
      padding: 12px 24px;
      border-radius: 50px;
      font-family: 'Poppins', sans-serif;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .btn-reset:hover {
      background: white;
      color: var(--roxo);
      transform: scale(1.05);
    }

    /* Container Principal */
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 30px;
    }

    /* Telas */
    .tela {
      display: none;
    }

    .tela.ativa {
      display: block;
      animation: fadeIn 0.5s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Cards */
    .card {
      background: var(--bg-card);
      border-radius: 24px;
      padding: 30px;
      margin-bottom: 30px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.3);
      border: 1px solid rgba(255,255,255,0.1);
    }

    .card-title {
      font-family: 'Pacifico', cursive;
      font-size: 1.8rem;
      margin-bottom: 25px;
      display: flex;
      align-items: center;
      gap: 12px;
      background: linear-gradient(135deg, var(--roxo), var(--rosa));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    /* Upload de Fotos */
    .upload-zone {
      border: 3px dashed rgba(102, 126, 234, 0.5);
      border-radius: 20px;
      padding: 40px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      background: rgba(102, 126, 234, 0.05);
    }

    .upload-zone:hover {
      border-color: var(--roxo);
      background: rgba(102, 126, 234, 0.1);
      transform: scale(1.01);
    }

    .upload-zone.dragover {
      border-color: var(--verde);
      background: rgba(67, 233, 123, 0.1);
    }

    .upload-icon {
      font-size: 4rem;
      margin-bottom: 15px;
    }

    .upload-text {
      font-size: 1.2rem;
      color: var(--text-muted);
    }

    .upload-text strong {
      color: var(--roxo);
    }

    #input-fotos {
      display: none;
    }

    /* Bot√£o fotos anteriores */
    .btn-fotos-anteriores {
      display: block;
      width: 100%;
      margin-top: 15px;
      padding: 15px;
      border: 2px dashed var(--laranja);
      border-radius: 12px;
      background: rgba(245, 175, 25, 0.1);
      color: var(--laranja);
      font-family: 'Poppins', sans-serif;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .btn-fotos-anteriores:hover {
      background: rgba(245, 175, 25, 0.2);
      transform: scale(1.01);
    }

    /* Modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
    }

    .modal-overlay.ativa {
      display: flex;
    }

    .modal {
      background: var(--bg-dark);
      border-radius: 20px;
      max-width: 900px;
      width: 100%;
      max-height: 80vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      box-shadow: 0 10px 50px rgba(0, 0, 0, 0.5);
    }

    .modal-header {
      padding: 20px 25px;
      background: linear-gradient(135deg, var(--roxo) 0%, var(--rosa) 100%);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-title {
      font-family: 'Pacifico', cursive;
      font-size: 1.5rem;
    }

    .modal-close {
      background: rgba(255,255,255,0.2);
      border: none;
      color: white;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      font-size: 1.5rem;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .modal-close:hover {
      background: rgba(255,255,255,0.3);
      transform: rotate(90deg);
    }

    .modal-body {
      padding: 25px;
      overflow-y: auto;
      flex: 1;
    }

    .modal-loading {
      text-align: center;
      padding: 40px;
      color: var(--text-muted);
    }

    .modal-empty {
      text-align: center;
      padding: 40px;
      color: var(--text-muted);
    }

    .modal-empty-icon {
      font-size: 4rem;
      margin-bottom: 15px;
    }

    .fotos-anteriores-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
      gap: 12px;
    }

    .foto-anterior {
      position: relative;
      aspect-ratio: 3/4;
      border-radius: 10px;
      overflow: hidden;
      cursor: pointer;
      border: 3px solid transparent;
      transition: all 0.3s ease;
    }

    .foto-anterior:hover {
      transform: scale(1.05);
      border-color: var(--roxo);
    }

    .foto-anterior.selecionada {
      border-color: var(--verde);
      box-shadow: 0 0 20px rgba(67, 233, 123, 0.5);
    }

    .foto-anterior img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .foto-anterior .check {
      position: absolute;
      top: 5px;
      right: 5px;
      width: 25px;
      height: 25px;
      background: var(--verde);
      border-radius: 50%;
      display: none;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      color: white;
    }

    .foto-anterior.selecionada .check {
      display: flex;
    }

    .modal-footer {
      padding: 20px 25px;
      background: rgba(0, 0, 0, 0.2);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 15px;
    }

    .modal-info {
      color: var(--text-muted);
    }

    .modal-info strong {
      color: var(--verde);
    }

    .modal-btns {
      display: flex;
      gap: 10px;
    }

    .btn-modal {
      padding: 12px 25px;
      border-radius: 25px;
      font-family: 'Poppins', sans-serif;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .btn-modal-cancelar {
      background: transparent;
      border: 2px solid rgba(255,255,255,0.3);
      color: white;
    }

    .btn-modal-cancelar:hover {
      border-color: white;
    }

    .btn-modal-confirmar {
      background: linear-gradient(135deg, var(--verde) 0%, #38d9a9 100%);
      border: none;
      color: white;
    }

    .btn-modal-confirmar:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 20px rgba(67, 233, 123, 0.4);
    }

    .btn-modal-confirmar:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    /* Preview de Fotos */
    .fotos-container {
      margin-top: 25px;
    }

    .fotos-count {
      font-size: 1.1rem;
      margin-bottom: 15px;
      color: var(--text-muted);
    }

    .fotos-count strong {
      color: var(--verde);
      font-size: 1.3rem;
    }

    .fotos-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 15px;
    }

    .foto-preview {
      position: relative;
      aspect-ratio: 3/4;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
      animation: popIn 0.3s ease;
    }

    @keyframes popIn {
      from { transform: scale(0); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }

    .foto-preview img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .foto-preview .btn-remover {
      position: absolute;
      top: 5px;
      right: 5px;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: var(--vermelho);
      border: none;
      color: white;
      font-size: 1rem;
      cursor: pointer;
      opacity: 0;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .foto-preview:hover .btn-remover {
      opacity: 1;
    }

    .foto-preview .btn-remover:hover {
      transform: scale(1.2);
    }

    /* Configura√ß√µes */
    .config-section {
      margin-top: 30px;
    }

    .config-label {
      font-weight: 600;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 1.1rem;
    }

    /* N√≠veis */
    .niveis-container {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
    }

    .nivel-btn {
      flex: 1;
      min-width: 150px;
      padding: 20px;
      border-radius: 16px;
      border: 3px solid rgba(255,255,255,0.1);
      background: rgba(255,255,255,0.05);
      color: white;
      cursor: pointer;
      transition: all 0.3s ease;
      text-align: center;
    }

    .nivel-btn:hover {
      transform: translateY(-3px);
      border-color: rgba(255,255,255,0.3);
    }

    .nivel-btn.selecionado {
      border-color: var(--verde);
      background: rgba(67, 233, 123, 0.15);
    }

    .nivel-btn.selecionado.facil { border-color: var(--verde); background: rgba(67, 233, 123, 0.15); }
    .nivel-btn.selecionado.medio { border-color: var(--laranja); background: rgba(245, 175, 25, 0.15); }
    .nivel-btn.selecionado.dificil { border-color: var(--vermelho); background: rgba(239, 68, 68, 0.15); }

    .nivel-nome {
      font-weight: 700;
      font-size: 1.2rem;
      margin-bottom: 5px;
    }

    .nivel-info {
      font-size: 0.9rem;
      color: var(--text-muted);
    }

    /* Slider de Tempo */
    .slider-container {
      margin-top: 20px;
    }

    .slider-value {
      font-size: 2rem;
      font-weight: 700;
      color: var(--azul);
      text-align: center;
      margin-bottom: 10px;
    }

    input[type="range"] {
      width: 100%;
      height: 8px;
      border-radius: 4px;
      background: rgba(255,255,255,0.1);
      appearance: none;
      outline: none;
    }

    input[type="range"]::-webkit-slider-thumb {
      appearance: none;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--azul), var(--roxo));
      cursor: pointer;
      box-shadow: 0 4px 15px rgba(79, 172, 254, 0.5);
    }

    /* Input de Nome */
    .input-nome {
      width: 100%;
      padding: 18px 24px;
      border-radius: 16px;
      border: 2px solid rgba(255,255,255,0.1);
      background: rgba(255,255,255,0.05);
      color: white;
      font-family: 'Poppins', sans-serif;
      font-size: 1.1rem;
      transition: all 0.3s ease;
      margin-top: 10px;
    }

    .input-nome:focus {
      outline: none;
      border-color: var(--roxo);
      background: rgba(102, 126, 234, 0.1);
    }

    .input-nome::placeholder {
      color: rgba(255,255,255,0.4);
    }

    /* Bot√£o Criar */
    .btn-criar {
      width: 100%;
      padding: 20px;
      margin-top: 30px;
      border: none;
      border-radius: 16px;
      background: linear-gradient(135deg, var(--verde) 0%, #38d9a9 100%);
      color: white;
      font-family: 'Poppins', sans-serif;
      font-size: 1.3rem;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 6px 25px rgba(67, 233, 123, 0.4);
    }

    .btn-criar:hover {
      transform: translateY(-3px);
      box-shadow: 0 10px 35px rgba(67, 233, 123, 0.5);
    }

    .btn-criar:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    /* Partidas Ativas */
    .partidas-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
      gap: 25px;
      margin-top: 20px;
    }

    .partida-card {
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(240, 147, 251, 0.1));
      border-radius: 20px;
      padding: 25px;
      border: 2px solid rgba(255,255,255,0.1);
      transition: all 0.3s ease;
    }

    .partida-card:hover {
      transform: translateY(-5px);
      border-color: rgba(255,255,255,0.2);
    }

    .partida-nome {
      font-family: 'Pacifico', cursive;
      font-size: 1.5rem;
      margin-bottom: 15px;
    }

    .qr-container {
      background: white;
      padding: 15px;
      border-radius: 12px;
      display: inline-block;
      margin: 15px 0;
    }

    .qr-code {
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .qr-code img {
      display: block;
    }

    .partida-info {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      margin: 15px 0;
    }

    .info-badge {
      background: rgba(255,255,255,0.1);
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 0.9rem;
    }

    .partida-btns {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 15px;
    }

    .btn-partida {
      flex: 1;
      min-width: 120px;
      padding: 12px 20px;
      border: none;
      border-radius: 12px;
      font-family: 'Poppins', sans-serif;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .btn-iniciar {
      background: linear-gradient(135deg, var(--verde), #38d9a9);
      color: white;
    }

    .btn-ver {
      background: linear-gradient(135deg, var(--azul), var(--roxo));
      color: white;
    }

    .btn-encerrar {
      background: linear-gradient(135deg, var(--vermelho), #dc2626);
      color: white;
    }

    .btn-partida:hover {
      transform: translateY(-2px);
      filter: brightness(1.1);
    }

    /* Lista de Jogadores */
    .jogadores-lista {
      margin-top: 15px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    .jogador-badge {
      display: flex;
      align-items: center;
      gap: 8px;
      background: rgba(255,255,255,0.1);
      padding: 8px 15px;
      border-radius: 25px;
    }

    .jogador-foto-mini {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid var(--verde);
    }

    /* ================================ */
    /* TELA DO JOGO */
    /* ================================ */

    .tela-jogo {
      height: calc(100vh - 100px);
      display: flex;
      gap: 30px;
    }

    /* √Årea do Tabuleiro */
    .area-tabuleiro {
      flex: 6;
      display: flex;
      flex-direction: column;
    }

    .tabuleiro-header {
      text-align: center;
      margin-bottom: 20px;
    }

    .jogo-titulo {
      font-family: 'Pacifico', cursive;
      font-size: 2rem;
      background: linear-gradient(135deg, var(--roxo), var(--rosa));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .ultima-jogada {
      background: rgba(255,255,255,0.1);
      padding: 12px 20px;
      border-radius: 12px;
      margin-top: 10px;
      font-size: 1rem;
    }

    .ultima-jogada.acerto {
      background: rgba(67, 233, 123, 0.2);
      color: var(--verde);
    }

    .ultima-jogada.erro {
      background: rgba(239, 68, 68, 0.2);
      color: var(--vermelho);
    }

    /* Tabuleiro de Cartas */
    .tabuleiro {
      flex: 1;
      display: grid;
      gap: 12px;
      padding: 20px;
      background: rgba(0,0,0,0.2);
      border-radius: 20px;
      align-content: center;
      justify-content: center;
    }

    .tabuleiro.facil {
      /* F√°cil: 8 pares = 16 cartas = 4x4 */
      grid-template-columns: repeat(4, minmax(80px, 120px));
    }

    .tabuleiro.medio {
      /* M√©dio: 12 pares = 24 cartas = 6x4 */
      grid-template-columns: repeat(6, minmax(60px, 100px));
    }

    .tabuleiro.dificil {
      /* Dif√≠cil: 18 pares = 36 cartas = 6x6 */
      grid-template-columns: repeat(6, minmax(50px, 90px));
    }

    /* Cartas */
    .carta {
      aspect-ratio: 3/4;
      cursor: default;
      perspective: 1000px;
    }

    .carta-inner {
      position: relative;
      width: 100%;
      height: 100%;
      transition: transform 0.6s;
      transform-style: preserve-3d;
    }

    .carta.virada .carta-inner {
      transform: rotateY(180deg);
    }

    .carta-frente,
    .carta-verso {
      position: absolute;
      width: 100%;
      height: 100%;
      backface-visibility: hidden;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 6px 20px rgba(0,0,0,0.3);
    }

    .carta-verso {
      background: linear-gradient(135deg, var(--roxo) 0%, var(--rosa) 100%);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .carta-verso::before {
      content: "?";
      font-family: 'Pacifico', cursive;
      font-size: 3rem;
      color: white;
      text-shadow: 0 4px 8px rgba(0,0,0,0.3);
    }

    .carta-frente {
      transform: rotateY(180deg);
      background: white;
    }

    .carta-frente img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .carta.encontrada {
      animation: cartaEncontrada 0.5s ease forwards;
    }

    @keyframes cartaEncontrada {
      to {
        opacity: 0;
        transform: scale(0.8);
        pointer-events: none;
      }
    }

    .carta.acertou .carta-inner {
      animation: celebrar 0.6s ease;
    }

    @keyframes celebrar {
      0%, 100% { transform: rotateY(180deg) scale(1); }
      25% { transform: rotateY(180deg) scale(1.1) rotate(-5deg); }
      75% { transform: rotateY(180deg) scale(1.1) rotate(5deg); }
    }

    .carta.errou .carta-inner {
      animation: shake 0.4s ease;
    }

    @keyframes shake {
      0%, 100% { transform: rotateY(180deg) translateX(0); }
      25% { transform: rotateY(180deg) translateX(-10px); }
      75% { transform: rotateY(180deg) translateX(10px); }
    }

    /* √Årea do Placar */
    .area-placar {
      flex: 4;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .placar-section {
      background: var(--bg-card);
      border-radius: 20px;
      padding: 25px;
      border: 1px solid rgba(255,255,255,0.1);
    }

    .section-title {
      font-family: 'Pacifico', cursive;
      font-size: 1.5rem;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    /* Ranking */
    .ranking-lista {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .ranking-item {
      display: flex;
      align-items: center;
      gap: 15px;
      padding: 12px 15px;
      background: rgba(255,255,255,0.05);
      border-radius: 12px;
      transition: all 0.3s ease;
    }

    .ranking-item.atual {
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.2), rgba(240, 147, 251, 0.2));
      border: 2px solid var(--roxo);
    }

    .ranking-posicao {
      font-size: 1.5rem;
      font-weight: 700;
      width: 40px;
    }

    .ranking-item:nth-child(1) .ranking-posicao { color: var(--amarelo); }
    .ranking-item:nth-child(2) .ranking-posicao { color: #c0c0c0; }
    .ranking-item:nth-child(3) .ranking-posicao { color: #cd7f32; }

    .ranking-foto {
      width: 45px;
      height: 45px;
      border-radius: 50%;
      object-fit: cover;
      border: 3px solid rgba(255,255,255,0.2);
    }

    .ranking-info {
      flex: 1;
    }

    .ranking-nome {
      font-weight: 600;
      font-size: 1.1rem;
    }

    .ranking-pares {
      display: flex;
      gap: 3px;
      margin-top: 5px;
    }

    .ranking-pares .estrela {
      color: var(--amarelo);
      font-size: 1rem;
    }

    /* Vez Atual */
    .vez-container {
      text-align: center;
    }

    .vez-jogador {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 15px;
      padding: 25px;
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.15), rgba(240, 147, 251, 0.15));
      border-radius: 16px;
      border: 2px solid var(--roxo);
      animation: pulsar 2s ease-in-out infinite;
    }

    @keyframes pulsar {
      0%, 100% { box-shadow: 0 0 0 0 rgba(102, 126, 234, 0.4); }
      50% { box-shadow: 0 0 30px 10px rgba(102, 126, 234, 0.2); }
    }

    .vez-foto {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      object-fit: cover;
      border: 4px solid var(--rosa);
      box-shadow: 0 6px 25px rgba(240, 147, 251, 0.4);
    }

    .vez-nome {
      font-size: 1.4rem;
      font-weight: 700;
    }

    .vez-timer {
      font-size: 3rem;
      font-weight: 800;
      background: linear-gradient(135deg, var(--laranja), var(--vermelho));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .vez-timer.baixo {
      animation: timerBaixo 0.5s ease infinite;
    }

    @keyframes timerBaixo {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }

    /* Estat√≠sticas */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
    }

    .stat-item {
      background: rgba(255,255,255,0.05);
      padding: 15px;
      border-radius: 12px;
      text-align: center;
    }

    .stat-valor {
      font-size: 2rem;
      font-weight: 700;
      color: var(--azul);
    }

    .stat-label {
      font-size: 0.85rem;
      color: var(--text-muted);
      margin-top: 5px;
    }

    /* Bot√µes do Jogo */
    .jogo-btns {
      display: flex;
      gap: 15px;
      margin-top: auto;
    }

    .btn-jogo {
      flex: 1;
      padding: 15px;
      border: none;
      border-radius: 12px;
      font-family: 'Poppins', sans-serif;
      font-weight: 600;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .btn-pausar {
      background: linear-gradient(135deg, var(--laranja), #f59e0b);
      color: white;
    }

    .btn-voltar {
      background: rgba(255,255,255,0.1);
      color: white;
      border: 2px solid rgba(255,255,255,0.2);
    }

    .btn-jogo:hover {
      transform: translateY(-2px);
    }

    /* ================================ */
    /* TELA FIM DE JOGO */
    /* ================================ */

    .tela-fim {
      text-align: center;
      padding: 40px;
    }

    .fim-titulo {
      font-family: 'Pacifico', cursive;
      font-size: 4rem;
      background: linear-gradient(135deg, var(--amarelo), var(--laranja));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 40px;
      animation: pulseTitle 2s ease infinite;
    }

    @keyframes pulseTitle {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    /* P√≥dio */
    .podio-container {
      display: flex;
      justify-content: center;
      align-items: flex-end;
      gap: 20px;
      margin: 50px 0;
      padding: 0 20px;
    }

    .podio-lugar {
      display: flex;
      flex-direction: column;
      align-items: center;
      animation: subirPodio 0.8s ease backwards;
    }

    .podio-lugar:nth-child(1) { animation-delay: 0.5s; }
    .podio-lugar:nth-child(2) { animation-delay: 0.3s; order: -1; }
    .podio-lugar:nth-child(3) { animation-delay: 0.1s; }

    @keyframes subirPodio {
      from { transform: translateY(100px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    .podio-foto {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      object-fit: cover;
      margin-bottom: 15px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    }

    .podio-lugar:nth-child(2) .podio-foto {
      width: 150px;
      height: 150px;
      border: 5px solid var(--amarelo);
    }

    .podio-nome {
      font-weight: 700;
      font-size: 1.2rem;
      margin-bottom: 5px;
    }

    .podio-pares {
      color: var(--text-muted);
      margin-bottom: 15px;
    }

    .podio-base {
      width: 150px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 3rem;
      font-weight: 800;
      border-radius: 12px 12px 0 0;
    }

    .podio-lugar:nth-child(1) .podio-base {
      height: 80px;
      background: linear-gradient(135deg, #c0c0c0, #a8a8a8);
      color: white;
    }

    .podio-lugar:nth-child(2) .podio-base {
      height: 120px;
      background: linear-gradient(135deg, var(--amarelo), #ffc107);
      color: white;
      width: 180px;
    }

    .podio-lugar:nth-child(3) .podio-base {
      height: 60px;
      background: linear-gradient(135deg, #cd7f32, #b8860b);
      color: white;
    }

    .coroa {
      font-size: 3rem;
      animation: float 2s ease-in-out infinite;
    }

    @keyframes float {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }

    /* Ranking Final */
    .ranking-final {
      max-width: 500px;
      margin: 40px auto;
      background: var(--bg-card);
      border-radius: 20px;
      padding: 30px;
    }

    .ranking-final-titulo {
      font-family: 'Pacifico', cursive;
      font-size: 1.8rem;
      margin-bottom: 25px;
    }

    .ranking-final-item {
      display: flex;
      align-items: center;
      gap: 15px;
      padding: 15px;
      border-radius: 12px;
      margin-bottom: 10px;
      background: rgba(255,255,255,0.05);
    }

    .ranking-final-item:nth-child(2) { background: linear-gradient(135deg, rgba(255, 215, 0, 0.2), rgba(255, 193, 7, 0.1)); }
    .ranking-final-item:nth-child(3) { background: linear-gradient(135deg, rgba(192, 192, 192, 0.2), rgba(168, 168, 168, 0.1)); }
    .ranking-final-item:nth-child(4) { background: linear-gradient(135deg, rgba(205, 127, 50, 0.2), rgba(184, 134, 11, 0.1)); }

    .ranking-final-pos {
      font-size: 1.8rem;
      width: 50px;
    }

    .ranking-final-foto {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      object-fit: cover;
    }

    .ranking-final-nome {
      flex: 1;
      font-weight: 600;
      text-align: left;
    }

    .ranking-final-pares {
      font-weight: 700;
      color: var(--verde);
    }

    /* Bot√µes Fim */
    .fim-btns {
      display: flex;
      gap: 20px;
      justify-content: center;
      margin-top: 40px;
    }

    .btn-fim {
      padding: 18px 40px;
      border: none;
      border-radius: 16px;
      font-family: 'Poppins', sans-serif;
      font-size: 1.2rem;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .btn-jogar-novamente {
      background: linear-gradient(135deg, var(--verde), #38d9a9);
      color: white;
    }

    .btn-nova-partida {
      background: linear-gradient(135deg, var(--roxo), var(--rosa));
      color: white;
    }

    .btn-fim:hover {
      transform: translateY(-3px);
      filter: brightness(1.1);
    }

    /* ================================ */
    /* CONFETES */
    /* ================================ */

    .confetti-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 9999;
      overflow: hidden;
    }

    .confetti-piece {
      position: absolute;
      width: 10px;
      height: 10px;
      top: -10px;
      animation: confettiFall 3s ease-out forwards;
    }

    @keyframes confettiFall {
      to {
        transform: translateY(100vh) rotate(720deg);
        opacity: 0;
      }
    }

    /* Aguardando Jogadores */
    .aguardando {
      text-align: center;
      padding: 40px;
    }

    .aguardando-texto {
      font-size: 1.5rem;
      color: var(--text-muted);
      margin-top: 30px;
    }

    .loader {
      width: 60px;
      height: 60px;
      border: 5px solid rgba(255,255,255,0.1);
      border-top-color: var(--roxo);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 30px auto;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Mensagem vazia */
    .empty-message {
      text-align: center;
      padding: 40px;
      color: var(--text-muted);
    }

    .empty-message .emoji {
      font-size: 4rem;
      margin-bottom: 20px;
    }

    /* Responsivo */
    @media (max-width: 1200px) {
      .tela-jogo {
        flex-direction: column;
        height: auto;
      }

      .area-placar {
        flex-direction: row;
        flex-wrap: wrap;
      }

      .placar-section {
        flex: 1;
        min-width: 280px;
      }
    }

    @media (max-width: 768px) {
      .header {
        flex-direction: column;
        gap: 15px;
        text-align: center;
      }

      .logo {
        font-size: 1.8rem;
      }

      .partidas-grid {
        grid-template-columns: 1fr;
      }

      .podio-container {
        flex-direction: column;
      }

      .podio-lugar:nth-child(2) {
        order: 0;
      }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="header">
    <div class="logo">
      <span class="logo-emoji">üé¥</span>
      <span>Jogo da Mem√≥ria dos Veloso</span>
    </div>
    <button class="btn-reset" onclick="resetarTudo()">üîÑ RESET GERAL</button>
  </header>

  <div class="container">
    <!-- TELA 1: CONFIGURA√á√ÉO -->
    <div id="tela-config" class="tela ativa">
      <!-- Card Criar Partida -->
      <div class="card">
        <h2 class="card-title">üì∏ CRIAR NOVA PARTIDA</h2>
        
        <!-- Upload de Fotos -->
        <div class="upload-zone" id="upload-zone" onclick="document.getElementById('input-fotos').click()">
          <div class="upload-icon">üì∑</div>
          <div class="upload-text">
            <strong>Arraste fotos</strong> ou clique para selecionar<br>
            <small>M√≠nimo 8 fotos para n√≠vel f√°cil</small>
          </div>
        </div>
        <input type="file" id="input-fotos" multiple accept="image/*">
        
        <!-- Bot√£o Fotos Anteriores -->
        <button class="btn-fotos-anteriores" onclick="abrirFotosAnteriores()">
          üìÇ Usar fotos de jogos anteriores
        </button>

        <!-- Preview das Fotos -->
        <div class="fotos-container" id="fotos-container" style="display: none;">
          <div class="fotos-count">Fotos carregadas: <strong id="fotos-count">0</strong></div>
          <div class="fotos-grid" id="fotos-grid"></div>
        </div>

        <!-- Configura√ß√µes -->
        <div class="config-section">
          <div class="config-label">‚öôÔ∏è N√≠vel de Dificuldade:</div>
          <div class="niveis-container">
            <button class="nivel-btn facil selecionado" data-nivel="facil" onclick="selecionarNivel('facil')">
              <div class="nivel-nome">üü¢ F√°cil</div>
              <div class="nivel-info">8 pares (4√ó4)</div>
            </button>
            <button class="nivel-btn medio" data-nivel="medio" onclick="selecionarNivel('medio')">
              <div class="nivel-nome">üü° M√©dio</div>
              <div class="nivel-info">12 pares (4√ó6)</div>
            </button>
            <button class="nivel-btn dificil" data-nivel="dificil" onclick="selecionarNivel('dificil')">
              <div class="nivel-nome">üî¥ Dif√≠cil</div>
              <div class="nivel-info">18 pares (6√ó6)</div>
            </button>
          </div>
        </div>

        <div class="config-section slider-container">
          <div class="config-label">‚è±Ô∏è Tempo por jogada:</div>
          <div class="slider-value"><span id="tempo-valor">10</span>s</div>
          <input type="range" id="tempo-slider" min="5" max="30" value="10" oninput="atualizarTempo(this.value)">
        </div>

        <div class="config-section">
          <div class="config-label">‚úèÔ∏è Nome da Partida:</div>
          <input type="text" class="input-nome" id="nome-partida" placeholder='ex: "Mem√≥ria Natal 2024"'>
        </div>

        <button class="btn-criar" id="btn-criar" onclick="criarPartida()" disabled>
          üéÆ CRIAR PARTIDA
        </button>
      </div>

      <!-- Card Partidas Ativas -->
      <div class="card">
        <h2 class="card-title">üéØ PARTIDAS ATIVAS</h2>
        <div id="partidas-lista"></div>
      </div>
    </div>

    <!-- TELA 2: JOGO -->
    <div id="tela-jogo" class="tela">
      <div class="tela-jogo">
        <!-- √Årea do Tabuleiro -->
        <div class="area-tabuleiro">
          <div class="tabuleiro-header">
            <h2 class="jogo-titulo" id="jogo-titulo">üé¥ Jogo da Mem√≥ria</h2>
            <div class="ultima-jogada" id="ultima-jogada"></div>
          </div>
          <div class="tabuleiro" id="tabuleiro"></div>
        </div>

        <!-- √Årea do Placar -->
        <div class="area-placar">
          <!-- Ranking -->
          <div class="placar-section">
            <h3 class="section-title">üèÜ Ranking</h3>
            <div class="ranking-lista" id="ranking-lista"></div>
          </div>

          <!-- Vez Atual -->
          <div class="placar-section">
            <h3 class="section-title">üéØ Vez de:</h3>
            <div class="vez-container" id="vez-container">
              <div class="aguardando">
                <div class="loader"></div>
                <div class="aguardando-texto">Aguardando in√≠cio...</div>
              </div>
            </div>
          </div>

          <!-- Estat√≠sticas -->
          <div class="placar-section">
            <h3 class="section-title">üìä Estat√≠sticas</h3>
            <div class="stats-grid">
              <div class="stat-item">
                <div class="stat-valor" id="stat-jogadas">0</div>
                <div class="stat-label">Total de Jogadas</div>
              </div>
              <div class="stat-item">
                <div class="stat-valor" id="stat-encontrados">0</div>
                <div class="stat-label">Pares Encontrados</div>
              </div>
              <div class="stat-item">
                <div class="stat-valor" id="stat-total">0</div>
                <div class="stat-label">Total de Pares</div>
              </div>
              <div class="stat-item">
                <div class="stat-valor" id="stat-faltam">0</div>
                <div class="stat-label">Faltam</div>
              </div>
            </div>
          </div>

          <!-- Bot√µes -->
          <div class="jogo-btns">
            <button class="btn-jogo btn-voltar" onclick="voltarConfig()">‚¨ÖÔ∏è Voltar</button>
            <button class="btn-jogo btn-encerrar" onclick="encerrarPartidaAtual()">üõë Encerrar</button>
          </div>
        </div>
      </div>
    </div>

    <!-- TELA 3: FIM DE JOGO -->
    <div id="tela-fim" class="tela">
      <h1 class="fim-titulo">üèÜ FIM DE JOGO! üèÜ</h1>
      
      <div class="podio-container" id="podio-container"></div>

      <div class="ranking-final">
        <h3 class="ranking-final-titulo">üìã Ranking Completo</h3>
        <div id="ranking-final-lista"></div>
      </div>

      <div class="fim-btns">
        <button class="btn-fim btn-jogar-novamente" onclick="jogarNovamente()">üîÑ Jogar Novamente</button>
        <button class="btn-fim btn-nova-partida" onclick="novaPartida()">‚ûï Nova Partida</button>
      </div>
    </div>
  </div>

  <!-- Modal Fotos Anteriores -->
  <div class="modal-overlay" id="modal-fotos">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title">üìÇ Fotos Anteriores</h2>
        <button class="modal-close" onclick="fecharFotosAnteriores()">‚úï</button>
      </div>
      <div class="modal-body" id="modal-fotos-body">
        <div class="modal-loading">
          <div class="loader"></div>
          <p>Carregando fotos...</p>
        </div>
      </div>
      <div class="modal-footer">
        <div class="modal-info">
          Selecionadas: <strong id="fotos-selecionadas-count">0</strong>
        </div>
        <div class="modal-btns">
          <button class="btn-modal btn-modal-cancelar" onclick="fecharFotosAnteriores()">Cancelar</button>
          <button class="btn-modal btn-modal-confirmar" id="btn-usar-fotos" onclick="usarFotosSelecionadas()" disabled>
            ‚úì Usar Fotos
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ==========================================
    // CONFIGURA√á√ÉO FIREBASE
    // ==========================================
    const firebaseConfig = {
      apiKey: "AIzaSyCwU3iGOAk1p4AHQe3EpYrShx5zzSe4S5Q",
      authDomain: "jogodamemoria-61432.firebaseapp.com",
      databaseURL: "https://jogodamemoria-61432-default-rtdb.firebaseio.com",
      projectId: "jogodamemoria-61432",
      storageBucket: "jogodamemoria-61432.firebasestorage.app",
      messagingSenderId: "131881486944",
      appId: "1:131881486944:web:653271faeb8ab0f5e25105"
    };

    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    const storage = firebase.storage();

    // ==========================================
    // VARI√ÅVEIS GLOBAIS
    // ==========================================
    let fotosCarregadas = [];
    let nivelSelecionado = 'facil';
    let tempoPorJogada = 10;
    let partidaAtualId = null;
    let unsubscribers = [];

    const NIVEIS = {
      facil: { pares: 8, colunas: 4 },
      medio: { pares: 12, colunas: 6 },
      dificil: { pares: 18, colunas: 6 }
    };

    // Fun√ß√£o auxiliar para gerar avatar padr√£o
    function gerarAvatarPadrao(nome) {
      const inicial = nome ? nome.charAt(0).toUpperCase() : '?';
      return 'data:image/svg+xml,' + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="50" fill="#667eea"/><text x="50" y="65" text-anchor="middle" fill="white" font-size="40" font-family="sans-serif">' + inicial + '</text></svg>');
    }

    // ==========================================
    // UPLOAD DE FOTOS
    // ==========================================
    const uploadZone = document.getElementById('upload-zone');
    const inputFotos = document.getElementById('input-fotos');

    // Drag and drop
    uploadZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadZone.classList.add('dragover');
    });

    uploadZone.addEventListener('dragleave', () => {
      uploadZone.classList.remove('dragover');
    });

    uploadZone.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadZone.classList.remove('dragover');
      handleFiles(e.dataTransfer.files);
    });

    inputFotos.addEventListener('change', (e) => {
      handleFiles(e.target.files);
    });

    async function handleFiles(files) {
      const filesArray = Array.from(files);
      
      for (const file of filesArray) {
        if (!file.type.startsWith('image/')) continue;
        
        // Mostrar preview
        const preview = criarPreview(file);
        document.getElementById('fotos-grid').appendChild(preview);
        
        // Upload para Firebase Storage
        try {
          const url = await uploadFoto(file);
          fotosCarregadas.push(url);
          preview.dataset.url = url;
        } catch (error) {
          console.error('Erro no upload:', error);
          preview.remove();
        }
        
        atualizarContador();
      }
    }

    function criarPreview(file) {
      const div = document.createElement('div');
      div.className = 'foto-preview';
      
      const img = document.createElement('img');
      img.src = URL.createObjectURL(file);
      
      const btnRemover = document.createElement('button');
      btnRemover.className = 'btn-remover';
      btnRemover.innerHTML = '‚úï';
      btnRemover.onclick = (e) => {
        e.stopPropagation();
        const url = div.dataset.url;
        if (url) {
          fotosCarregadas = fotosCarregadas.filter(f => f !== url);
        }
        div.remove();
        atualizarContador();
      };
      
      div.appendChild(img);
      div.appendChild(btnRemover);
      
      return div;
    }

    async function uploadFoto(file) {
      const resized = await resizeImage(file, 800, 1000);
      const timestamp = Date.now();
      const random = Math.random().toString(36).substr(2, 9);
      const path = `memorias/${timestamp}_${random}.jpg`;
      
      const storageRef = storage.ref(path);
      await storageRef.put(resized);
      
      return await storageRef.getDownloadURL();
    }

    function resizeImage(file, maxWidth, maxHeight) {
      return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          const img = new Image();
          img.onload = () => {
            const canvas = document.createElement('canvas');
            let width = img.width;
            let height = img.height;
            
            if (width > height) {
              if (width > maxWidth) {
                height = (height * maxWidth) / width;
                width = maxWidth;
              }
            } else {
              if (height > maxHeight) {
                width = (width * maxHeight) / height;
                height = maxHeight;
              }
            }
            
            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, width, height);
            
            canvas.toBlob(resolve, 'image/jpeg', 0.8);
          };
          img.src = e.target.result;
        };
        reader.readAsDataURL(file);
      });
    }

    function atualizarContador() {
      const count = fotosCarregadas.length;
      document.getElementById('fotos-count').textContent = count;
      document.getElementById('fotos-container').style.display = count > 0 ? 'block' : 'none';
      
      // Verificar se pode criar partida
      const minFotos = NIVEIS[nivelSelecionado].pares;
      document.getElementById('btn-criar').disabled = count < minFotos;
    }

    // ==========================================
    // FOTOS ANTERIORES
    // ==========================================
    let fotosAnteriores = [];
    let fotosSelecionadasModal = [];

    async function abrirFotosAnteriores() {
      // Mostrar modal
      document.getElementById('modal-fotos').classList.add('ativa');
      
      // Resetar sele√ß√£o
      fotosSelecionadasModal = [];
      atualizarContadorModal();
      
      // Carregar fotos
      document.getElementById('modal-fotos-body').innerHTML = '<div class="modal-loading"><div class="loader"></div><p>Carregando fotos...</p></div>';
      
      try {
        fotosAnteriores = await listarFotosStorage();
        
        if (fotosAnteriores.length === 0) {
          document.getElementById('modal-fotos-body').innerHTML = '<div class="modal-empty"><div class="modal-empty-icon">üì∑</div><p>Nenhuma foto encontrada.</p><p><small>Fa√ßa upload de fotos para come√ßar.</small></p></div>';
          return;
        }
        
        renderizarFotosAnteriores();
        
      } catch (error) {
        console.error('Erro ao carregar fotos:', error);
        document.getElementById('modal-fotos-body').innerHTML = '<div class="modal-empty"><div class="modal-empty-icon">‚ùå</div><p>Erro ao carregar fotos.</p><p><small>' + error.message + '</small></p></div>';
      }
    }

    async function listarFotosStorage() {
      const fotos = [];
      
      // Listar pasta /memorias/
      try {
        const memoriasRef = storage.ref('memorias');
        const memoriasResult = await memoriasRef.listAll();
        
        for (const item of memoriasResult.items) {
          try {
            const url = await item.getDownloadURL();
            fotos.push({ name: item.name, url: url, path: item.fullPath });
          } catch (e) {
            console.warn('Erro ao obter URL:', item.name);
          }
        }
      } catch (e) {
        console.log('Pasta memorias n√£o existe ou vazia');
      }
      
      // Ordenar por nome (mais recentes primeiro se tiver timestamp)
      fotos.sort((a, b) => b.name.localeCompare(a.name));
      
      return fotos;
    }

    function renderizarFotosAnteriores() {
      const container = document.getElementById('modal-fotos-body');
      
      let html = '<div class="fotos-anteriores-grid">';
      
      fotosAnteriores.forEach((foto, idx) => {
        const selecionada = fotosSelecionadasModal.includes(foto.url) ? 'selecionada' : '';
        html += '<div class="foto-anterior ' + selecionada + '" onclick="toggleFotoAnterior(' + idx + ')" data-url="' + foto.url + '">' +
          '<img src="' + foto.url + '" alt="Foto">' +
          '<div class="check">‚úì</div>' +
        '</div>';
      });
      
      html += '</div>';
      
      container.innerHTML = html;
    }

    function toggleFotoAnterior(idx) {
      const foto = fotosAnteriores[idx];
      const urlIndex = fotosSelecionadasModal.indexOf(foto.url);
      
      if (urlIndex === -1) {
        fotosSelecionadasModal.push(foto.url);
      } else {
        fotosSelecionadasModal.splice(urlIndex, 1);
      }
      
      // Atualizar visual
      const elementos = document.querySelectorAll('.foto-anterior');
      elementos[idx].classList.toggle('selecionada');
      
      atualizarContadorModal();
    }

    function atualizarContadorModal() {
      const count = fotosSelecionadasModal.length;
      document.getElementById('fotos-selecionadas-count').textContent = count;
      document.getElementById('btn-usar-fotos').disabled = count === 0;
    }

    function fecharFotosAnteriores() {
      document.getElementById('modal-fotos').classList.remove('ativa');
    }

    function usarFotosSelecionadas() {
      if (fotosSelecionadasModal.length === 0) return;
      
      // Adicionar √†s fotos carregadas (evitando duplicatas)
      fotosSelecionadasModal.forEach(url => {
        if (!fotosCarregadas.includes(url)) {
          fotosCarregadas.push(url);
          
          // Criar preview
          const preview = criarPreviewUrl(url);
          document.getElementById('fotos-grid').appendChild(preview);
        }
      });
      
      atualizarContador();
      fecharFotosAnteriores();
    }

    function criarPreviewUrl(url) {
      const div = document.createElement('div');
      div.className = 'foto-preview';
      div.dataset.url = url;
      
      const img = document.createElement('img');
      img.src = url;
      
      const btnRemover = document.createElement('button');
      btnRemover.className = 'btn-remover';
      btnRemover.innerHTML = '‚úï';
      btnRemover.onclick = (e) => {
        e.stopPropagation();
        fotosCarregadas = fotosCarregadas.filter(f => f !== url);
        div.remove();
        atualizarContador();
      };
      
      div.appendChild(img);
      div.appendChild(btnRemover);
      
      return div;
    }

    // ==========================================
    // CONFIGURA√á√ïES
    // ==========================================
    function selecionarNivel(nivel) {
      nivelSelecionado = nivel;
      document.querySelectorAll('.nivel-btn').forEach(btn => {
        btn.classList.remove('selecionado');
      });
      document.querySelector(`[data-nivel="${nivel}"]`).classList.add('selecionado');
      atualizarContador();
    }

    function atualizarTempo(valor) {
      tempoPorJogada = parseInt(valor);
      document.getElementById('tempo-valor').textContent = valor;
    }

    // ==========================================
    // CRIAR PARTIDA
    // ==========================================
    async function criarPartida() {
      const nome = document.getElementById('nome-partida').value.trim() || `Partida ${Date.now()}`;
      const minFotos = NIVEIS[nivelSelecionado].pares;
      
      if (fotosCarregadas.length < minFotos) {
        alert(`Voc√™ precisa de pelo menos ${minFotos} fotos para o n√≠vel ${nivelSelecionado}`);
        return;
      }
      
      const partidaId = database.ref('partidas').push().key;
      
      // Selecionar fotos necess√°rias
      const fotosSelecionadas = fotosCarregadas.slice(0, minFotos);
      
      // Criar tabuleiro
      const tabuleiro = criarTabuleiro(fotosSelecionadas, nivelSelecionado);
      
      // Salvar partida
      await database.ref(`partidas/${partidaId}`).set({
        nome: nome,
        fotos: fotosSelecionadas,
        nivel: nivelSelecionado,
        totalPares: minFotos,
        tempoPorJogada: tempoPorJogada,
        maxJogadores: 6,
        ativa: true,
        jogando: false,
        vezDoJogador: null,
        paresEncontrados: 0,
        totalJogadas: 0,
        finalizada: false,
        vencedor: null,
        criadaEm: Date.now()
      });
      
      // Salvar tabuleiro
      await database.ref(`tabuleiro/${partidaId}`).set(tabuleiro);
      
      // Limpar formul√°rio
      fotosCarregadas = [];
      document.getElementById('fotos-grid').innerHTML = '';
      document.getElementById('fotos-container').style.display = 'none';
      document.getElementById('nome-partida').value = '';
      atualizarContador();
      
      alert('Partida criada com sucesso!');
    }

    function criarTabuleiro(fotos, nivel) {
      const cartas = [];
      
      fotos.forEach((foto, idx) => {
        cartas.push({ id: `c${idx}_a`, fotoUrl: foto, encontrada: false });
        cartas.push({ id: `c${idx}_b`, fotoUrl: foto, encontrada: false });
      });
      
      // Embaralhar
      const posicoes = embaralhar(cartas.map(c => c.id));
      
      // Criar objeto de cartas indexado
      const cartasObj = {};
      cartas.forEach(c => {
        cartasObj[c.id] = c;
      });
      
      return { cartas: cartasObj, posicoes };
    }

    function embaralhar(array) {
      const arr = [...array];
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    // ==========================================
    // LISTAR PARTIDAS ATIVAS
    // ==========================================
    function carregarPartidas() {
      database.ref('partidas').orderByChild('ativa').equalTo(true).on('value', (snapshot) => {
        const container = document.getElementById('partidas-lista');
        container.innerHTML = '';
        
        const partidas = snapshot.val();
        if (!partidas) {
          container.innerHTML = `
            <div class="empty-message">
              <div class="emoji">üé¥</div>
              <p>Nenhuma partida ativa</p>
              <p><small>Crie uma nova partida acima</small></p>
            </div>
          `;
          return;
        }
        
        const grid = document.createElement('div');
        grid.className = 'partidas-grid';
        
        Object.entries(partidas).forEach(([id, partida]) => {
          const card = criarCardPartida(id, partida);
          grid.appendChild(card);
        });
        
        container.appendChild(grid);
      });
    }

    function criarCardPartida(id, partida) {
      const card = document.createElement('div');
      card.className = 'partida-card';
      
      // Gerar URL do jogador
      const baseUrl = window.location.href.replace('index.html', '').replace(/\/$/, '');
      const jogadorUrl = `${baseUrl}/jogador.html?partida=${id}`;
      
      card.innerHTML = `
        <div class="partida-nome">${partida.nome}</div>
        <div class="qr-container">
          <div id="qr-${id}" class="qr-code"></div>
        </div>
        <div class="partida-info">
          <span class="info-badge">üìä ${partida.nivel}</span>
          <span class="info-badge">‚è±Ô∏è ${partida.tempoPorJogada}s</span>
          <span class="info-badge" id="jogadores-count-${id}">üë• 0/6</span>
        </div>
        <div class="jogadores-lista" id="jogadores-lista-${id}"></div>
        <div class="partida-btns">
          <button class="btn-partida btn-iniciar" onclick="iniciarJogo('${id}')" ${partida.jogando ? 'disabled' : ''}>
            ${partida.jogando ? 'üéÆ Em Andamento' : '‚ñ∂Ô∏è Iniciar'}
          </button>
          <button class="btn-partida btn-ver" onclick="abrirJogo('${id}')">üëÅÔ∏è Ver</button>
          <button class="btn-partida btn-encerrar" onclick="encerrarPartida('${id}')">üóëÔ∏è Encerrar</button>
        </div>
      `;
      
      // Gerar QR Code
      setTimeout(() => {
        const qrContainer = document.getElementById(`qr-${id}`);
        if (qrContainer) {
          qrContainer.innerHTML = '';
          new QRCode(qrContainer, {
            text: jogadorUrl,
            width: 180,
            height: 180,
            colorDark: "#1a1a2e",
            colorLight: "#ffffff"
          });
        }
      }, 100);
      
      // Carregar jogadores
      carregarJogadoresPartida(id);
      
      return card;
    }

    function carregarJogadoresPartida(partidaId) {
      database.ref('jogadores').orderByChild('partidaId').equalTo(partidaId).on('value', (snapshot) => {
        const lista = document.getElementById(`jogadores-lista-${partidaId}`);
        const count = document.getElementById(`jogadores-count-${partidaId}`);
        
        if (!lista || !count) return;
        
        const jogadores = snapshot.val();
        const jogadoresArray = jogadores ? Object.values(jogadores).filter(j => j.ativo) : [];
        
        console.log('Jogadores na partida:', jogadoresArray);
        
        count.textContent = `üë• ${jogadoresArray.length}/6`;
        
        lista.innerHTML = jogadoresArray.map(j => {
          const fotoSrc = j.foto || gerarAvatarPadrao(j.nome);
          return `
            <div class="jogador-badge">
              <img src="${fotoSrc}" class="jogador-foto-mini" alt="${j.nome}">
              <span>${j.nome}</span>
            </div>
          `;
        }).join('');
      });
    }

    // ==========================================
    // INICIAR JOGO
    // ==========================================
    async function iniciarJogo(partidaId) {
      // Verificar se h√° jogadores
      const jogadoresSnap = await database.ref('jogadores').orderByChild('partidaId').equalTo(partidaId).once('value');
      const jogadores = jogadoresSnap.val();
      
      if (!jogadores) {
        alert('Aguarde pelo menos 1 jogador entrar na partida!');
        return;
      }
      
      const jogadoresAtivos = Object.entries(jogadores).filter(([id, j]) => j.ativo);
      
      if (jogadoresAtivos.length < 1) {
        alert('Aguarde pelo menos 1 jogador entrar na partida!');
        return;
      }
      
      // Definir ordem dos jogadores
      jogadoresAtivos.forEach(([id, j], idx) => {
        database.ref(`jogadores/${id}/ordem`).set(idx);
      });
      
      // Iniciar partida
      const primeiroJogador = jogadoresAtivos[0][0];
      
      await database.ref(`partidas/${partidaId}`).update({
        jogando: true,
        vezDoJogador: primeiroJogador
      });
      
      // Iniciar timer
      await database.ref(`jogada_atual/${partidaId}`).set({
        jogadorId: primeiroJogador,
        cartasViradas: [],
        inicioJogada: Date.now()
      });
      
      // Abrir tela do jogo
      abrirJogo(partidaId);
    }

    function abrirJogo(partidaId) {
      partidaAtualId = partidaId;
      mostrarTela('tela-jogo');
      carregarJogo(partidaId);
    }

    // ==========================================
    // CARREGAR JOGO
    // ==========================================
    function carregarJogo(partidaId) {
      // Limpar listeners anteriores
      unsubscribers.forEach(unsub => unsub());
      unsubscribers = [];
      
      // Listener da partida
      const partidaRef = database.ref(`partidas/${partidaId}`);
      partidaRef.on('value', (snap) => {
        const partida = snap.val();
        if (!partida) return;
        
        document.getElementById('jogo-titulo').textContent = `üé¥ ${partida.nome}`;
        document.getElementById('stat-total').textContent = partida.totalPares;
        document.getElementById('stat-encontrados').textContent = partida.paresEncontrados || 0;
        document.getElementById('stat-faltam').textContent = partida.totalPares - (partida.paresEncontrados || 0);
        document.getElementById('stat-jogadas').textContent = partida.totalJogadas || 0;
        
        if (partida.finalizada) {
          mostrarFimDeJogo(partidaId);
        }
        
        atualizarVezAtual(partida.vezDoJogador);
      });
      unsubscribers.push(() => partidaRef.off());
      
      // Listener do tabuleiro
      const tabuleiroRef = database.ref(`tabuleiro/${partidaId}`);
      tabuleiroRef.on('value', (snap) => {
        const tabuleiro = snap.val();
        if (tabuleiro) {
          renderizarTabuleiro(tabuleiro, partidaId);
        }
      });
      unsubscribers.push(() => tabuleiroRef.off());
      
      // Listener da jogada atual
      const jogadaRef = database.ref(`jogada_atual/${partidaId}`);
      jogadaRef.on('value', (snap) => {
        const jogada = snap.val();
        if (jogada) {
          atualizarCartasViradas(jogada.cartasViradas || []);
          atualizarTimer(jogada);
        }
      });
      unsubscribers.push(() => jogadaRef.off());
      
      // Listener dos jogadores (ranking)
      const jogadoresRef = database.ref('jogadores').orderByChild('partidaId').equalTo(partidaId);
      jogadoresRef.on('value', (snap) => {
        const jogadores = snap.val();
        if (jogadores) {
          atualizarRanking(jogadores);
        }
      });
      unsubscribers.push(() => jogadoresRef.off());
      
      // Listener da √∫ltima jogada
      const ultimaRef = database.ref(`ultima_jogada/${partidaId}`);
      ultimaRef.on('value', (snap) => {
        const ultima = snap.val();
        if (ultima) {
          mostrarUltimaJogada(ultima);
        }
      });
      unsubscribers.push(() => ultimaRef.off());
    }

    async function renderizarTabuleiro(tabuleiro, partidaId) {
      const container = document.getElementById('tabuleiro');
      const partidaSnap = await database.ref(`partidas/${partidaId}`).once('value');
      const partida = partidaSnap.val();
      
      container.className = `tabuleiro ${partida.nivel}`;
      container.innerHTML = '';
      
      tabuleiro.posicoes.forEach((cartaId, idx) => {
        const carta = tabuleiro.cartas[cartaId];
        const div = document.createElement('div');
        div.className = 'carta';
        div.dataset.posicao = idx;
        div.dataset.cartaId = cartaId;
        
        if (carta.encontrada) {
          div.classList.add('encontrada');
        }
        
        div.innerHTML = `
          <div class="carta-inner">
            <div class="carta-verso"></div>
            <div class="carta-frente">
              <img src="${carta.fotoUrl}" alt="Carta">
            </div>
          </div>
        `;
        
        container.appendChild(div);
      });
    }

    function atualizarCartasViradas(posicoes) {
      document.querySelectorAll('.carta').forEach((carta, idx) => {
        if (posicoes.includes(idx)) {
          carta.classList.add('virada');
        } else if (!carta.classList.contains('encontrada')) {
          carta.classList.remove('virada');
        }
      });
    }

    async function atualizarVezAtual(jogadorId) {
      const container = document.getElementById('vez-container');
      
      if (!jogadorId) {
        container.innerHTML = `
          <div class="aguardando">
            <div class="loader"></div>
            <div class="aguardando-texto">Aguardando in√≠cio...</div>
          </div>
        `;
        return;
      }
      
      const jogadorSnap = await database.ref(`jogadores/${jogadorId}`).once('value');
      const jogador = jogadorSnap.val();
      
      if (!jogador) return;
      
      container.innerHTML = `
        <div class="vez-jogador">
          <img src="${jogador.foto || gerarAvatarPadrao(jogador.nome)}" class="vez-foto" alt="${jogador.nome}">
          <div class="vez-nome">${jogador.nome}</div>
          <div class="vez-timer" id="vez-timer">--</div>
        </div>
      `;
    }

    let timerInterval = null;

    function atualizarTimer(jogada) {
      if (timerInterval) clearInterval(timerInterval);
      
      const timerEl = document.getElementById('vez-timer');
      if (!timerEl) return;
      
      database.ref(`partidas/${partidaAtualId}/tempoPorJogada`).once('value').then(snap => {
        const tempoPorJogada = snap.val() || 10;
        
        const calcularTempo = () => {
          const agora = Date.now();
          const passado = Math.floor((agora - jogada.inicioJogada) / 1000);
          const restante = Math.max(0, tempoPorJogada - passado);
          
          timerEl.textContent = `${restante}s`;
          timerEl.classList.toggle('baixo', restante <= 3);
          
          return restante;
        };
        
        calcularTempo();
        
        timerInterval = setInterval(() => {
          const restante = calcularTempo();
          if (restante <= 0) {
            clearInterval(timerInterval);
          }
        }, 1000);
      });
    }

    function atualizarRanking(jogadores) {
      const container = document.getElementById('ranking-lista');
      
      const jogadoresArray = Object.entries(jogadores)
        .filter(([id, j]) => j.ativo)
        .map(([id, j]) => ({ id, ...j }))
        .sort((a, b) => (b.pares || 0) - (a.pares || 0));
      
      container.innerHTML = jogadoresArray.map((j, idx) => `
        <div class="ranking-item">
          <div class="ranking-posicao">${idx + 1}¬∫</div>
          <img src="${j.foto || gerarAvatarPadrao(j.nome)}" class="ranking-foto" alt="${j.nome}">
          <div class="ranking-info">
            <div class="ranking-nome">${j.nome}</div>
            <div class="ranking-pares">
              ${'‚≠ê'.repeat(j.pares || 0) || '-'}
            </div>
          </div>
        </div>
      `).join('');
    }

    async function mostrarUltimaJogada(ultima) {
      const container = document.getElementById('ultima-jogada');
      
      // Buscar nome do jogador
      let nomeJogador = 'Jogador';
      try {
        const jogadorSnap = await database.ref('jogadores/' + ultima.jogador).once('value');
        const jogador = jogadorSnap.val();
        if (jogador) {
          nomeJogador = jogador.nome;
        }
      } catch (e) {
        console.error('Erro ao buscar jogador:', e);
      }
      
      container.className = 'ultima-jogada ' + ultima.tipo;
      container.innerHTML = ultima.tipo === 'acerto' 
        ? '‚úÖ ' + nomeJogador + ' acertou! +1 par'
        : '‚ùå ' + nomeJogador + ' errou!';
      
      // Anima√ß√£o nas cartas
      if (ultima.posicoes && ultima.posicoes.length === 2) {
        const cartas = document.querySelectorAll('.carta');
        ultima.posicoes.forEach(pos => {
          if (cartas[pos]) {
            cartas[pos].classList.add(ultima.tipo === 'acerto' ? 'acertou' : 'errou');
            setTimeout(() => {
              cartas[pos].classList.remove('acertou', 'errou');
            }, 600);
          }
        });
        
        // Confetes se acertou
        if (ultima.tipo === 'acerto') {
          mostrarConfetes();
        }
      }
    }

    // ==========================================
    // FIM DE JOGO
    // ==========================================
    async function mostrarFimDeJogo(partidaId) {
      mostrarTela('tela-fim');
      
      // Buscar jogadores
      const jogadoresSnap = await database.ref('jogadores').orderByChild('partidaId').equalTo(partidaId).once('value');
      const jogadores = jogadoresSnap.val();
      
      const ranking = Object.entries(jogadores)
        .filter(([id, j]) => j.ativo)
        .map(([id, j]) => ({ id, ...j }))
        .sort((a, b) => (b.pares || 0) - (a.pares || 0));
      
      // P√≥dio
      const podio = document.getElementById('podio-container');
      podio.innerHTML = '';
      
      const top3 = ranking.slice(0, 3);
      const posicoes = ['ü•à', 'ü•á', 'ü•â'];
      const ordem = [1, 0, 2]; // 2¬∫, 1¬∫, 3¬∫
      
      ordem.forEach(i => {
        if (top3[i]) {
          const j = top3[i];
          const lugar = document.createElement('div');
          lugar.className = 'podio-lugar';
          lugar.innerHTML = `
            ${i === 0 ? '<div class="coroa">üëë</div>' : ''}
            <img src="${j.foto || gerarAvatarPadrao(j.nome)}" class="podio-foto" alt="${j.nome}">
            <div class="podio-nome">${j.nome}</div>
            <div class="podio-pares">${j.pares || 0} pares</div>
            <div class="podio-base">${i + 1}</div>
          `;
          podio.appendChild(lugar);
        }
      });
      
      // Ranking completo
      const rankingContainer = document.getElementById('ranking-final-lista');
      rankingContainer.innerHTML = ranking.map((j, idx) => `
        <div class="ranking-final-item">
          <div class="ranking-final-pos">${['ü•á', 'ü•à', 'ü•â'][idx] || `${idx + 1}¬∫`}</div>
          <img src="${j.foto || gerarAvatarPadrao(j.nome)}" class="ranking-final-foto" alt="${j.nome}">
          <div class="ranking-final-nome">${j.nome}</div>
          <div class="ranking-final-pares">${j.pares || 0} pares</div>
        </div>
      `).join('');
      
      // Confetes!
      mostrarConfetes();
      setTimeout(mostrarConfetes, 500);
      setTimeout(mostrarConfetes, 1000);
    }

    // ==========================================
    // CONFETES
    // ==========================================
    function mostrarConfetes() {
      const container = document.createElement('div');
      container.className = 'confetti-container';
      document.body.appendChild(container);
      
      const cores = ['#667eea', '#764ba2', '#f093fb', '#4facfe', '#43e97b', '#ffd700'];
      
      for (let i = 0; i < 50; i++) {
        const piece = document.createElement('div');
        piece.className = 'confetti-piece';
        piece.style.left = Math.random() * 100 + '%';
        piece.style.background = cores[Math.floor(Math.random() * cores.length)];
        piece.style.animationDelay = Math.random() * 0.5 + 's';
        piece.style.animationDuration = (2 + Math.random() * 2) + 's';
        piece.style.borderRadius = Math.random() > 0.5 ? '50%' : '0';
        piece.style.width = (5 + Math.random() * 10) + 'px';
        piece.style.height = (5 + Math.random() * 10) + 'px';
        container.appendChild(piece);
      }
      
      setTimeout(() => container.remove(), 4000);
    }

    // ==========================================
    // A√á√ïES
    // ==========================================
    async function encerrarPartida(partidaId) {
      if (!confirm('Tem certeza que deseja encerrar esta partida?')) return;
      
      await database.ref(`partidas/${partidaId}`).update({ ativa: false });
      await database.ref(`tabuleiro/${partidaId}`).remove();
      await database.ref(`jogada_atual/${partidaId}`).remove();
      await database.ref(`ultima_jogada/${partidaId}`).remove();
      
      // Remover jogadores
      const jogadoresSnap = await database.ref('jogadores').orderByChild('partidaId').equalTo(partidaId).once('value');
      const jogadores = jogadoresSnap.val();
      if (jogadores) {
        for (const id of Object.keys(jogadores)) {
          await database.ref(`jogadores/${id}`).remove();
        }
      }
    }

    function encerrarPartidaAtual() {
      if (partidaAtualId) {
        encerrarPartida(partidaAtualId);
        voltarConfig();
      }
    }

    function voltarConfig() {
      unsubscribers.forEach(unsub => unsub());
      unsubscribers = [];
      if (timerInterval) clearInterval(timerInterval);
      partidaAtualId = null;
      mostrarTela('tela-config');
    }

    async function jogarNovamente() {
      if (!partidaAtualId) return;
      
      // Buscar partida
      const partidaSnap = await database.ref(`partidas/${partidaAtualId}`).once('value');
      const partida = partidaSnap.val();
      
      if (!partida) return;
      
      // Recriar tabuleiro
      const tabuleiro = criarTabuleiro(partida.fotos, partida.nivel);
      
      // Buscar jogadores e resetar pontua√ß√£o
      const jogadoresSnap = await database.ref('jogadores').orderByChild('partidaId').equalTo(partidaAtualId).once('value');
      const jogadores = jogadoresSnap.val();
      
      const jogadoresIds = jogadores ? Object.keys(jogadores).filter(id => jogadores[id].ativo) : [];
      
      for (const id of jogadoresIds) {
        await database.ref(`jogadores/${id}/pares`).set(0);
      }
      
      // Resetar partida
      const primeiroJogador = jogadoresIds[0] || null;
      
      await database.ref(`partidas/${partidaAtualId}`).update({
        jogando: true,
        vezDoJogador: primeiroJogador,
        paresEncontrados: 0,
        totalJogadas: 0,
        finalizada: false,
        vencedor: null
      });
      
      await database.ref(`tabuleiro/${partidaAtualId}`).set(tabuleiro);
      
      await database.ref(`jogada_atual/${partidaAtualId}`).set({
        jogadorId: primeiroJogador,
        cartasViradas: [],
        inicioJogada: Date.now()
      });
      
      await database.ref(`ultima_jogada/${partidaAtualId}`).remove();
      
      // Voltar para tela do jogo
      mostrarTela('tela-jogo');
      carregarJogo(partidaAtualId);
    }

    function novaPartida() {
      partidaAtualId = null;
      voltarConfig();
    }

    async function resetarTudo() {
      if (!confirm('Isso vai remover TODAS as partidas e jogadores. Tem certeza?')) return;
      
      await database.ref('partidas').remove();
      await database.ref('jogadores').remove();
      await database.ref('tabuleiro').remove();
      await database.ref('jogada_atual').remove();
      await database.ref('ultima_jogada').remove();
      
      alert('Tudo foi resetado!');
      voltarConfig();
    }

    // ==========================================
    // NAVEGA√á√ÉO
    // ==========================================
    function mostrarTela(telaId) {
      document.querySelectorAll('.tela').forEach(tela => {
        tela.classList.remove('ativa');
      });
      document.getElementById(telaId).classList.add('ativa');
    }

    // ==========================================
    // INICIALIZA√á√ÉO
    // ==========================================
    carregarPartidas();
  </script>
</body>
</html>
